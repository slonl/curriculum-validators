<!doctype html>
<html>
<head>
    <title>Curriculum Importeer Tool</title>
    <meta charset="utf-8">
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>
    <link rel="stylesheet" href="js/vanillaSelectBox.css">
    <script src="js/vanillaSelectBox.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/extra.css">
    <!-- script src="https://cdn.lr-ingest.io/LogRocket.min.js" crossorigin="anonymous"></script -->
    <script>
        window.LogRocket && window.LogRocket.init('muze/entiteiten-editor');
    </script>
</head>
<body class="slo-main-page">
    <header class="slo-navbar">
        <nav class="slo-navbar-left slo-logo bg-brand-gradient">
            <a href="/"><img src="/assets/img/slo.png"></a>
        </nav>
        <div class="slo-navbar-left">
            OpenData Portal: Importeer Tool
        </div>
        <div class="slo-navbar-right slo-profile">
            <img class="slo-avatar" data-simply-field="user.avatar_url">
            <div class="slo-username" data-simply-field="user.name"></div>
            <a href="#" class="slo-logoff" data-simply-command="logoff">Afmelden</a>
        </div>
    </header>
    <div class="slo-navbar slo-navbar-side bg-gray">
        <div class="slo-space">
            <p>
                Aangepaste Entiteiten
        <div data-simply-field="changeCount" data-simply-content="template" data-simply-default-template="default">
            <template data-simply-template="0">
                        <textarea disabled placeholder="Commit message" data-simply-field="commitMessage"></textarea>
            </template>
            <template data-simply-template="default">
                <textarea placeholder="Commit message" data-simply-field="commitMessage"></textarea>
            </template>
        </div>
            </p>
            <p>
                <span data-simply-field="changeCount">0</span> aanpassingen
        <div data-simply-field="changeCount" data-simply-content="template" data-simply-default-template="default">
            <template data-simply-template="0">
                        <button disabled class="slo-button slo-commit">Verwerken</button>
            </template>
            <template data-simply-template="default">
                        <button data-simply-command="commit-changes" class="slo-button slo-commit">Verwerken</button>
                        <button data-simply-command="remove-changes" class="slo-button slo-commit">Verwijder wijzigingen</button>
            </template>
        </div>
            </p>
            <div class="slo-entiteit-changes" data-simply-list="changes">
                <template>
                    <div class="slo-entiteit-change">
                        <button data-simply-command="delete-change" class="slo-button slo-right">
                            <svg class="slo-icon slo-icon-feather">
                                <use xlink:href="/files/feather-sprite.svg#trash">
                                </use>
                            </svg>
                        </button>
                        <input type="checkbox" checked data-simply-field="commit" value=1>
                        <span class="slo-title" data-simply-field="title"></span><br>
                        <span class="slo-type" data-simply-field="section"></span><br>
                        <a href="#" target="entiteiten-editor" class="slo-uuid" data-simply-field="id" data-simply-transformer="editlink"></a>
                    </div>
                </template>
            </div>
        </div>
    </div>
    <main class="slo-main slo-space-vertical" data-simply-field="page" data-simply-content="template" data-simply-default-value="upload">
    	<template data-simply-template="upload">
            <div class="slo-space">
            	<p>Kies de juiste context en upload een excel bestand met nieuwe data</p>
                <form data-simply-command="uploadXLSX" class="slo-grid slo-grid-3" data-simply-collection="upload">
					<select name="context" data-simply-element="context">
						<option>curriculum-basis</option>
						<option>curriculum-lpib</option>
						<option>curriculum-kerndoelen</option>
						<option>curriculum-examenprogramma</option>
						<option>curriculum-examenprogramma-bg</option>
						<option>curriculum-syllabus</option>
						<option>curriculum-leerdoelenkaarten</option>
						<option>curriculum-inhoudslijnen</option>
						<option>curriculum-referentiekader</option>
					</select>
					<label class="slo-button">
						<span class="slo-label" data-simply-field="selected-files">Selecteer bestanden</span>
		                <input class="slo-hidden" type="file" name="files" multiple="multiple" data-simply-element="files" accept=".xlsx">
		            </label>
		            <button class="slo-button" type="submit">Upload</button>
                </form>
                <div class="slo-space slo-excel-errors" data-simply-list="errors">
                		<template>
                			<div class="slo-excel-error">
                				<div class="slo-excel-error-message" data-simply-field="error"></div>
                				<div class="slo-file" data-simply-field="file"></div>
                				<table class="slo-table">
                					<thead>
                						<tr>
                							<th>regel</th>
                							<th>ID</th>
                							<th>ParentID</th>
                							<th>Prefix</th>
                							<th>Title</th>
                						</tr>
                					</thead>
                					<tbody data-simply-list="rows">
                					<template>
                						<tr class="slo-excel-row">
                							<td class="slo-excel-row-nr" data-simply-field="_row"></td>
                							<td data-simply-field="id"></td>
                							<td data-simply-field="parentId"></td>
                							<td data-simply-field="prefix"></td>
                							<td data-simply-field="title"></td>
                						</tr>
                					</template>
                					</tbody>
                				</table>
                			</div>
                		</template>
                </div>
                <div class="slo-space">
                	<ol class="slo-validation" data-simply-list="validation">
	                	<template>
                			<li>
								<span data-simply-field="innerHTML"></span>
								<a class="slo-tag" target="editor" data-simply-field="entity.id" data-simply-transformer="editlink" data-simply-content="fixed">
									<label class="slo-tag-label"><svg class="slo-icon slo-icon-feather"><use xlink:href="/assets/icons/feather-sprite.svg#link"></use></svg></label>
									<span data-simply-field="entity.id"></span>
								</a>
								<span data-simply-field="entity.prefix"></span>
								<span data-simply-field="entity.title"></span>
								<ul data-simply-list="errors">
									<template>
										<li>
											<span data-simply-field="innerHTML"></span>
											<ul data-simply-list="errors" data-simply-entry="entry">
												<template>
													<li><span data-simply-field="entry"></span></li>
												</template>
											</ul>
										</li>
									</template>
								</ul>
                			</li>
	                	</template>
	                </ol>	                
                </div>
                <div class="slo-tree-render"></div>
                <div class="slo-tree-changes"></div>
            </div>
        </template>
    </main>

    <dialog id="login" class="slo-login">
        <header class="bg-brand">
            <img src="/assets/img/slo.png" class="slo-logo">
        </header>
        <section class="body">
            <div class="slo-warning" data-simply-field="login-error"></div>
            <div class="slo-warning">Aanmelden met uw Github account</div>
            <form data-simply-command="login" method="POST">
                <div class="group">
                    <label>
                        Naam
                        <input type="text" name="username" id="username" data-simply-field="username" data-simply-element="username">
                    </label>
                </div>
                <div class="group">
                    <label>
                        Wachtwoord
                        <input type="password" name="password" data-simply-field="password" data-simply-element="password">
                    </label>
                </div>
                <div class="group">
                    <label>
                        <input type="checkbox" name="savelogin" value="1" data-simply-field="savelogin" data-simply-element="savelogin">
                        Bewaar mijn logingegevens op deze computer
                    </label>
                </div>
                <br>
                <button type="submit" class="slo-button slo-button-primary">Login
                    <div class="ripples buttonRipples"><span class="ripplesCircle"></span></div>
                </button>
            </form>
        </section>
    </dialog>
    
    <div class="slo-dialog-overlay"></div>


<script src="https://canary.simplyedit.io/1/simply-edit.js" xsrc="https://yvo.muze.nl/simply-edit/js/simply-edit.js" xsrc="https://cdn.simplyedit.io/1/simply-edit.js" data-simply-storage="none"></script>
<script src="js/GitHub.bundle.js"></script>
<script src="/js/simply/simply.everything.js"></script>
<script>
    simply.route.init({
        root: '/importeer-tool/'
    });

	window.repos = {
        'curriculum-lpib': 'slonl/curriculum-lpib',
        'curriculum-basis': 'slonl/curriculum-basis',
        'curriculum-kerndoelen': 'slonl/curriculum-kerndoelen',
        'curriculum-examenprogramma': 'slonl/curriculum-examenprogramma',
        'curriculum-examenprogramma-bg': 'slonl/curriculum-examenprogramma-bg',
        'curriculum-syllabus': 'slonl/curriculum-syllabus',
        'curriculum-doelgroepteksten': 'slonl/curriculum-doelgroepteksten',
        'curriculum-leerdoelenkaarten': 'slonl/curriculum-leerdoelenkaarten',
        'curriculum-inhoudslijnen': 'slonl/curriculum-inhoudslijnen',
        'curriculum-referentiekader': 'slonl/curriculum-referentiekader'        
    };
	
</script>

<script src="https://unpkg.com/json-schema-ref-parser@6.0.0/dist/ref-parser.min.js"></script>
<script src="https://unpkg.com/lodash@4.17.11/lodash.min.js"></script>
<script src="js/curriculum.js"></script>
<script src="js/importer.js"></script>
<script>

    editor.transformers = {
        "round" : {
            "render" : function(data) {
                return Math.round(100 * (1-data),2) + "%";
            }
        },
        "opendatalink" : {
            "render" : function(data) {
                this._data = data;
                data = "https://opendata.slo.nl/curriculum/api-acpt/v1/uuid/"+data;
                return data;
            },
            "extract": function() {
                return this._data;
            }
        },
        "editlink" : {
            "render" : function(data) {
            	this._data = data;
                return {
                    innerHTML : data,
                    href : 'https://opendata.slo.nl/curriculum/beheer/entiteiten-editor/#edit/' + data
                };
            },
            "extract" : function(el) {
                return this._data;
            }
        },
        "uuid": {
            "render": function(data) {
                this.id = data;
                return data;
            }
        },
        "idToTitle": {
            "render" : function(data) {
                this.sloId = data;
                var entity = clone(curriculum.index.id[data]);
                if (curriculum.index.type[data] == "doelniveau") {
                    if (entity.doel_id && entity.doel_id[0]) {
                        var doel = clone(curriculum.index.id[entity.doel_id[0]]);
                    } else if (entity.kerndoel_id && entity.kerndoel_id[0]) {
                        var doel = clone(curriculum.index.id[entity.kerndoel_id[0]]);
                    }
                    if (entity.niveau_id && entity.niveau_id[0]) {
                        var niveau = clone(curriculum.index.id[entity.niveau_id[0]]);
                    }
                    var result = '';
                    if (niveau && niveau.title ) {
                        result += '['+niveau.title+'] ';
                    } else {
                        result += '[geen niveau]';
                    }
                    if (doel && doel.title) {
                        result += doel.title;
                    } else {
                        result += 'geen doel';
                    }
                    return result;
                } else {
                    if (typeof curriculum.index.id[data] == 'undefined') {
                        return 'missing';
                    }
                    return curriculum.index.id[data].title ? clone(curriculum.index.id[data].title) : "";
                }
            },
            "extract" : function(el) {
                return this.sloId;
            }
        },
        "hasDescription" : {
            render : function(data) {
                return (typeof data.description !== "undefined");
            }
        },
        "hasTitle" : {
            render : function(data) {
                return (typeof data.title !== "undefined");
            }
        },
        "isarray" : {
            render : function(data) {
                this.data = data;
                return Array.isArray(data);
            },
            extract : function(el) {
                return this.data;
            }
        },
        "searchoption" : {
            render : function(entity) {
                entity = clone(entity);
                this.data = entity;
                var option = entity.title + " " + entity.id;

                if (curriculum.index.type[entity.id]=="doelniveau") {
                    var doel = clone(curriculum.index.id[entity.doel_id[0]]);
                    var niveau = clone(curriculum.index.id[entity.niveau_id[0]]);
                    option = "[" + niveau.title + "] " + doel.title + " " + entity.id;
                }

                return {
                    innerHTML : option,
                    value : entity.id
                };
            },
            extract : function(el) {
                return this.data;
            }
        }
    };

	simply.collect.addListener('upload', function(elements) { 
		var files = elements.files.files;
		switch(files.length) {
			case 0:
				editor.pageData['selected-files'] = 'Selecteer bestanden';
			break;
			case 1:
				editor.pageData['selected-files'] = '1 bestand';
			break;
			default:
				editor.pageData['selected-files'] = files.length+' bestanden';
			break;
		}
	});



	function escapeQuotes(s) {
		return s.replace('"','\x22').replace("'",'\x27');
	}
	
	function getDoelNiveauTitle(entity) {
		if (!entity.niveau_id || !Array.isArray(entity.niveau_id) || !entity.niveau_id.length) {
			var niveau = 'geen';
		} else {
			var niveau = entity.niveau_id.map(function(id) {
				return  curriculum.index.id[id].title;
			}).join(',');
		}
		var title = [];
		['doel_id','kerndoel_id','examenprogramma_eindterm_id','examenprogramma_subdomein_id','examenprogramma_domeid_id'].forEach(function(prop) {
			if (entity[prop] && Array.isArray(entity[prop]) && entity[prop].length) {
				entity[prop].forEach(function(childId) {
					title.push(prop.substr(0,prop.length-3)+': '+curriculum.index.id[childId].title);
				});
			}
		});
		return '('+niveau+') '+'['+(title.length)+'] '+title.join(',');
	}
	
    (function() {
        var login;
        var loginString = localStorage.getItem('login');
        if (loginString) {
            try {
                login = JSON.parse(loginString);
            } catch(e) {
            }
        }
        if (login) {
            importTool.actions.autologin(login.username, login.password);
        } else {
            importTool.actions.showLogin();
        }
    })();
    
    function clone(ob) {
        if (typeof ob == 'undefined' || ob == null) {
            return null;
        }
        return JSON.parse(JSON.stringify(ob));
    }


    // Yucky code, but chrome handles large datalists very poorly. This is to make it only do autocompletion
    // when enough characters have been entered. Firefox doesn't even break a sweat with this;
    if (window.chrome) {
        document.addEventListener("input", function(evt) {
            if (evt.target.hasAttribute("list") && !evt.target.hasAttribute("data-list")) {
                evt.target.setAttribute("data-list", evt.target.getAttribute("list"));
            }
            if (evt.target.getAttribute("data-list")) {
                if (evt.target.value.length > 3) {
                    evt.target.setAttribute("list", evt.target.getAttribute("data-list"));
                } else {
                    evt.target.removeAttribute("list");
                }
            }
        }, true);
    }


    simply.activate.addListener('autosize', function() {
        var self = this;
        self.style.height = 'auto';
        self.style.height = (self.scrollHeight+2)+'px';
           this.addEventListener('input',function(evt) {
            window.setTimeout(function() {
                self.style.height = 'auto';
                self.style.height = (self.scrollHeight+2)+'px';
            },0);
        });
    });

    /* Code to remember scroll position when the lists are changed and redrawn */
    function rememberScrollPosition() {
        window.scrollPosition = {
            y: window.scrollY,
            x: window.scrollX
        };
    }
    window.addEventListener("databind:elementresolved", function(evt) {
        window.setTimeout(function() {
            delete window.scrollPosition;
        }, 200);
    });

    window.addEventListener("scroll", function(evt) {
        if (typeof window.scrollPosition !== "undefined") {
            window.scrollTo(window.scrollPosition.x, window.scrollPosition.y);
        }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.0/jszip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.0/xlsx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.6/ajv.min.js"
integrity="sha512-+WCxUYg8L1mFBIyL05WJAJRP2UWCy+6mvpMHQbjPDdlDVcgS4XYyPhw5TVvzf9Dq8DTD/BedPW5745dqUeIP5g=="
crossorigin="anonymous"></script>
<script src="js/tree.js"></script>
<script src="js/validator.js"></script>
<script src="js/merge-context.js"></script>
</body>
</html>